from kivy.lang import Builder
from kivymd.app import MDApp
from kivy.uix.screenmanager import ScreenManager, Screen, RiseInTransition
from kivy.core.window import Window
from kivymd.toast import toast
# ----
from werkzeug.security import generate_password_hash, check_password_hash
import string
users = {}

class WindowManager(ScreenManager):
    pass

class LogInScreen(Screen):
    pass

class SignUpScreen(Screen):
    pass

class ForgotPasswordScreen(Screen):
    pass

class MainApp(MDApp):
    def build(self):
        self.theme_cls.theme_style = "Light"
        self.theme_cls.primary_palette = "BlueGray"
        WM = WindowManager()
        WM.add_widget(LogInScreen(name='LogInScreen'))
        WM.add_widget(SignUpScreen(name='SignUpScreen'))
        return Builder.load_file('main.kv')

    def check_input(self):
        current_screen = self.root.current
        if (current_screen == "LogInScreen"):
            self.LoginUsername_input = self.root.get_screen('LogInScreen').ids.username_input
            self.LoginPassword_input = self.root.get_screen('LogInScreen').ids.Password_input
            self.LoginUsername = self.LoginUsername_input.text
            self.LoginPassword = self.LoginPassword_input.text
            self.check_LogInScreen()
        
        if (current_screen == "ForgotPasswordScreen"):
            self.forgotUsername_input = self.root.get_screen('ForgotPasswordScreen').ids.username_input
            self.forgotEmail_input = self.root.get_screen('ForgotPasswordScreen').ids.email_input
            self.forgotUsername = self.forgotUsername_input.text
            self.forgotEmail = self.forgotEmail_input.text
            self.check_ForgotScreen()
        
        if (current_screen == "SignUpScreen"):
            self.SignupFullName_input = self.root.get_screen('SignUpScreen').ids.fullName_input
            self.SignupEmail_input = self.root.get_screen('SignUpScreen').ids.email_input
            self.SignupFullName = self.SignupFullName_input.text
            self.SignupEmail = self.SignupEmail_input.text
            self.check_SignUpScreen()
            
        print(current_screen)
    def check_LogInScreen(self):
        if not self.username or all(char in string.whitespace + string.punctuation for char in self.username):
            self.show_notification(True)

        elif not self.SignupEmail:
            self.show_notification(True)

        elif not self.password:
            self.show_notification(True)

        elif users and check_password_hash(users['password'], self.password):
            self.show_notification(False)
        else:
            self.show_notification(True)
        self.clear_input()

    def check_ForgotScreen(self):
        if not self.forgotUsername or all(char in string.whitespace + string.punctuation for char in self.forgotUsername):
            self.show_notification(True)

        elif users and check_password_hash(users['email'], self.forgotEmail):
            self.show_notification(False)
        else:
            self.show_notification(True)
        self.clear_input()
    
    def check_SignUpScreen(self): # --
        if not self.SignupFullName or all(char in string.whitespace + string.punctuation for char in self.SignupFullName):
            self.show_notification(True)

        elif users is None or not check_password_hash(users.get('email'), self.SignupEmail):
            self.show_notification(True)
        self.clear_input()

    def show_notification(self, check):
        if (check):
            toast('Sorry, Somthing has gone wrong')
        else:
            toast('Success')

    def clear_input(self):
        try:
            self.LoginUsername_input.text = ''
            self.LoginPassword_input.text = ''
        except AttributeError:
            pass

        try:
            self.forgotUsername_input.text = ''
            self.forgotEmail_input.text = ''
        except AttributeError:
            pass

        try:
            self.SignupFullName_input.text = ''
            self.SignupEmail_input.text = ''
        except AttributeError:
            pass


if __name__ == '__main__':
    Window.size = (360, 640)
    MainApp().run()
